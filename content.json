{"meta":{"title":"彭远春的技术专栏","subtitle":"积累一点，分享一点，快乐一点","description":"","author":"彭远春","url":"http://boke.pengyc.com","root":"/"},"pages":[{"title":"about","date":"2020-05-25T07:03:47.000Z","updated":"2020-05-25T07:07:22.372Z","comments":true,"path":"about/index.html","permalink":"http://boke.pengyc.com/about/index.html","excerpt":"","text":"Hello,pengyc"}],"posts":[{"title":"企业微信报警","slug":"企业微信报警","date":"2020-05-26T06:30:12.000Z","updated":"2020-05-26T06:56:24.290Z","comments":true,"path":"Language/python/企业微信报警","link":"","permalink":"http://boke.pengyc.com/Language/python/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%8A%A5%E8%AD%A6","excerpt":"","text":"python实现的通过企业微信发送zabbix报警信息，请通过企业微信创建应用，并记录相关CorpID、Secret、agentid,实现代码如下: 12345678910111213141516171819202122232425262728293031#!/usr/bin/env python# coding=utf-8#企业微信相关CorpID = 'XXXXXXXX'Secret = 'XXXXXXXX'agentid = 'XXXXXXXX'def get_api_url(CorpID, Secret): token_url = 'https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=%s&amp;corpsecret=%s' % (CorpID, Secret) send_baseurl = \"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=\" req = urllib2.Request(token_url) result = urllib2.urlopen(req) access_token = json.loads(result.read()) send_url = send_baseurl+access_token['access_token'] return send_urldef send_msg(CorpID,Secret,agentid,content): url = get_api_url(CorpID, Secret) values = &#123; \"touser\" : '@all', \"toparty\" : '2', \"msgtype\" : \"text\", \"agentid\" : agentid, \"text\" : &#123; \"content\" : content &#125;, \"safe\" :\"0\" &#125; send_data = json.dumps(values) send_request = urllib2.Request(url, send_data) response = json.loads(urllib2.urlopen(send_request).read())","categories":[{"name":"Language","slug":"Language","permalink":"http://boke.pengyc.com/categories/Language/"},{"name":"python","slug":"Language/python","permalink":"http://boke.pengyc.com/categories/Language/python/"}],"tags":[{"name":"python","slug":"python","permalink":"http://boke.pengyc.com/tags/python/"}]},{"title":"钉钉报警","slug":"钉钉报警","date":"2020-05-26T05:30:12.000Z","updated":"2020-05-26T06:57:04.892Z","comments":true,"path":"Language/python/钉钉报警","link":"","permalink":"http://boke.pengyc.com/Language/python/%E9%92%89%E9%92%89%E6%8A%A5%E8%AD%A6","excerpt":"","text":"参照钉钉官方文档：https://ding-doc.dingtalk.com/doc#/serverapi2/qf2nxq 自定义机器人webhook的安全设置有三种方式，分为自定义关键字、加签、IP地址。关键字和IP地址两种方式不涉及webhook的生成，只有加签方式涉及。故脚本分别通过两种不同的方法来获取api_url和发送信息。代码如下所示： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354#!/bin/env python# coding=utf-8import timeimport hmacimport hashlibimport base64import urllibimport requestsimport jsontimestamp=long(round(time.time() * 1000))def get_sign(secret): secret_enc = bytes(secret).encode('utf-8') string_to_sign = '&#123;&#125;\\n&#123;&#125;'.format(timestamp, secret) string_to_sign_enc = bytes(string_to_sign).encode('utf-8') hmac_code = hmac.new(secret_enc, string_to_sign_enc, digestmod=hashlib.sha256).digest() sign = urllib.quote_plus(base64.b64encode(hmac_code)) return signdef get_api_url_withsecret(token,secret): sign=get_sign(secret) base_url='https://oapi.dingtalk.com/robot/send?access_token=' return base_url+token+'&amp;timestamp='+str(timestamp)+'&amp;sign='+signdef get_api_url(token): base_url='https://oapi.dingtalk.com/robot/send?access_token=' return base_url+tokendef send_msg_withsecret(token,secret,text): api_url=get_api_url_withsecret(token,secret) headers = &#123;'Content-Type': 'application/json;charset=utf-8'&#125; json_text = &#123; \"msgtype\":\"text\", \"at\": &#123; #\"atMobiles\": [], \"isAtAll\": True &#125;, \"text\": &#123;\"content\": text &#125; &#125; requests.post(api_url, json.dumps(json_text), headers=headers).contentdef send_msg(token,text): api_url=get_api_url(token) headers = &#123;'Content-Type': 'application/json;charset=utf-8'&#125; json_text = &#123; \"msgtype\":\"text\", \"at\": &#123; #\"atMobiles\": [], \"isAtAll\": True &#125;, \"text\": &#123;\"content\": text &#125; &#125; requests.post(api_url, json.dumps(json_text), headers=headers).content","categories":[{"name":"Language","slug":"Language","permalink":"http://boke.pengyc.com/categories/Language/"},{"name":"python","slug":"Language/python","permalink":"http://boke.pengyc.com/categories/Language/python/"}],"tags":[{"name":"python","slug":"python","permalink":"http://boke.pengyc.com/tags/python/"}]}],"categories":[{"name":"Language","slug":"Language","permalink":"http://boke.pengyc.com/categories/Language/"},{"name":"python","slug":"Language/python","permalink":"http://boke.pengyc.com/categories/Language/python/"}],"tags":[{"name":"python","slug":"python","permalink":"http://boke.pengyc.com/tags/python/"}]}